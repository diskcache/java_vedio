<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="scripts/vue.js"></script>
    <script src="scripts/element.min.js"></script>
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/top.css">
    <script src="scripts/axios.js"></script>
    <script src="scripts/hls.js"></script>
</head>

<body>
    <div id="app">
        <div class="top">
            <div class="top-left">
                <div class="dropdown">
                    推荐
                    <div class="dropdown-content">
                        <p v-for="h in hots" :key="h.hot" class="h-item" @click="hot_play(h.filename)">{{h.filename}}
                        </p>
                    </div>
                </div>
                <div @click="getByUser">我的</div>
            </div>
            <div class="top-right">
                <div class="search">
                    <el-input class="search-input" style="width: 200px;" size="mini" v-model="key"></el-input>
                    <el-button class="search-button" type="primary" size="mini" @click="search">搜索</el-button>
                </div>
                <div class="user" @click="showLogin">
                    <ul class="userlist">
                        <li class="avatar">
                            <img
                                src="https://c-ssl.dtstatic.com/uploads/blog/202307/10/XxS5ql7AcQd7q59.thumb.400_0.jpg_webp">
                        </li>
                        <li class="username">{{username}}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="dialog" v-if="isloging">
            <div class="close-btn" @click="close">
                <i class="el-icon-close"></i>
            </div>
            <div class="avatar">
                <img src="https://c-ssl.dtstatic.com/uploads/blog/202307/10/XxS5ql7AcQd7q59.thumb.400_0.jpg_webp">
            </div>
            <form class="login-form">
                <div class="username">
                    <div>用户名</div>
                    <el-input style="width: 150px;" size="mini" v-model="loginform.username"></el-input>
                </div>
                <div class="password">
                    <div>密码</div>
                    <el-input style="width: 150px;" size="mini" type="password"
                        v-model="loginform.password">密码</el-input>
                </div>
                <div class="buttons">
                    <el-button size="mini" type="primary">登录</el-button>
                    <el-button size="mini">注册</el-button>
                </div>
            </form>
        </div>
        <div class="mid">
            <el-input v-model="title" placeholder="输入视频标题" style="width: 300px; margin: 10px 0;">
            </el-input>
            <div class="upload-section">
                <input type="file" @change="handleFileChange" />
                <div class="upload-controls">
                    <el-button @click="handleUpload" :disabled="!container.file">上传</el-button>
                    <el-button @click="handlePause" :disabled="percentage === 0">暂停</el-button>
                    <el-button @click="resume" :disabled="percentage === 0">继续</el-button>
                </div>
                <div class="progress-container">
                    <el-progress :percentage="percentage" status="success"></el-progress>
                </div>
            </div>
        </div>
    </div>
</body>
<style>

</style>
<script>
    function encode(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
            ).join(''));

            return JSON.parse(jsonPayload);
        } catch (e) {
            return null;
        }
    }

    axios.interceptors.request.use(config => {
        const token = localStorage.getItem('token');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    }, error => {
        return Promise.reject(error);
    });

    new Vue({
        el: "#app",
        data() {
            return {
                loginform: {
                    username: '',
                    password: '',
                },
                username: '',
                userId: '',
                key: '',
                isloging: false,
                container: {
                    file: null,
                    hash: null,
                },
                hots: [],
                title: '', // 标题字段
                percentage: 0, // 确保有百分比变量
                uploaded: 0, // 确保有上传进度变量
                cancelTokenList: [] // 确保有取消令牌列表
            }
        },
        created() {
            this.checkLogin();
            this.gethot();
        },
        methods: {
            getByUser() {
                if (!this.checkLogin()) {
                    this.$message.error("请先登录");
                    return
                }
                const form = new FormData
                form.append("userId", this.userId)
                axios.post('http://127.0.0.1:8000/vedios/user', form).then((res) => {
                    this.videos = res.data
                })
            },
            gethot() {
                axios.get('http://127.0.0.1:8000/vedios/hot').then((res) => {
                    this.hots = res.data
                    console.log(this.hots)
                })
            },
            hot_play(filename) {
                window.location.href = `play.html?video=${encodeURIComponent(filename)}`
            },
            showLogin() {
                if (this.checkLogin()) {
                    this.isloging = false;
                    this.$message.success("已登录")
                }
                else
                    this.isloging = true
            },
            close() { this.isloging = false },
            // 检查登录状态
            checkLogin() {
                const token = localStorage.getItem('token');
                if (token) {
                    const payload = encode(token);
                    this.userId = payload.userid;// 注意payload中的字段名是小写userid
                    this.username = payload.username;
                    return true;
                } else
                    return false;
            },
            login() {
                const form = new FormData;
                form.append("username", this.loginform.username)
                form.append("password", this.loginform.password)
                axios.post('http://127.0.0.1:8080/gateway/user/login', form).then((res) => {
                    if (res.data.token) {
                        localStorage.setItem('token', res.data.token);
                        this.username = res.data.username;
                        this.userId = res.data.userId;
                        this.$message.success(res.data.message)
                        this.isloging = false
                    } else
                        this.$message.error("error")
                })
            },
            search() {
                const form = new FormData;
                form.append("key", this.key);
                axios.post('http://127.0.0.1:8000/vedios/search', form).then((res) => {
                    this.videos = res.data
                })
            },
            // 处理文件选择
            handleFileChange(e) {
                const files = e.target.files;
                if (files.length === 0) {
                    this.container.file = null;
                    this.container.hash = null; // 清空旧哈希
                    this.percentage = 0; // 重置进度
                    this.uploaded = 0; // 重置已上传分片数
                    return;
                }

                this.container.file = files[0];
                this.container.hash = null;
                this.percentage = 0;
                this.uploaded = 0;
                // （可选）显示文件名，提升用户体验
                console.log("选中文件：", this.container.file.name);
            },
            async getVideoLength(file) {
                return new Promise((resolve, reject) => {
                    const url = URL.createObjectURL(file);
                    const videoElement = document.createElement('video');

                    videoElement.addEventListener('loadedmetadata', () => {
                        URL.revokeObjectURL(url);
                        resolve(Math.round(videoElement.duration));
                    });

                    videoElement.addEventListener('error', (e) => {
                        URL.revokeObjectURL(url);
                        reject(new Error('无法加载视频元数据'));
                    });
                    videoElement.src = url;
                });
            },
            // 上传处理
            async handleUpload() {
                if (!this.checkLogin()) {
                    this.$message.error("请先登录")
                    return
                }
                if (!this.container.file) return;
                try {
                    this.container.hash = await this.calculateHash(this.container.file);
                    console.log(this.container.hash)
                    const formData = new FormData();

                    formData.append('hash', this.container.hash);
                    formData.append('userId', this.userId); // 添加用户ID

                    var duration

                    await this.getVideoLength(this.container.file).then(res => {
                        duration = res
                    }).catch(error => {
                        console.error(error);
                    });

                    uploadTime = Date.now();

                    axios.post('http://127.0.0.1:8000/vedios/upload/check', formData).then((res) => {
                        if (res.status == 200)
                            this.$message.success('上传成功');

                        else {
                            const chunks = this.createFileChunk(this.container.file);
                            this.data = chunks.map(({ index, chunk }) => ({
                                index,
                                chunk,
                                hash: `${this.container.hash}`
                            }));
                            console.log(this.container.hash)
                            const total = this.data.length;

                            const metadata = new FormData
                            metadata.append('userid', this.userId); // 添加用户ID
                            metadata.append('title', this.title);
                            metadata.append('duration', duration);
                            metadata.append('uploadtime', uploadTime);
                            metadata.append('total', total);  // 总分片数
                            metadata.append('hash', this.container.hash);
                            metadata.append('filename', this.container.file.name);
                            axios.post('http://127.0.0.1:8000/vedios/upload/metadata', metadata).then(res => {
                                if (res.status == 201 || res.status == 200)
                                    this.uploadChunks()
                            })
                        }
                    })
                }
                catch (error) {
                    console.error("上传失败:", error);
                }
            },

            // 生成文件切片
            createFileChunk(file, size = 1 * 1024 * 1024) {
                const chunks = [];
                let cur = 0;
                while (cur < file.size) {
                    chunks.push({
                        index: chunks.length + 1,//不从0开始
                        chunk: file.slice(cur, cur + size)
                    });
                    cur += size;
                }
                return chunks;
            },
            // 切片上传
            async uploadChunks() {
                // 重置进度
                this.cancelTokenList = [];

                // 添加用户ID到每个请求
                // const userId = this.userInfo ? this.userInfo.userId : null;
                // if (!userId) {
                //     this.$message.error('用户信息缺失，请重新登录');
                //     return;
                // }
                if (!this.checkLogin()) {
                    this.$message.error("请先登录")
                    return
                }

                const total = this.data.length;

                this.percentage = Math.round((this.uploaded / (this.data.length - 1)) * 100);

                const chunks = this.data.filter((d) => d.index > this.uploaded)
                // 生成上传请求
                const requests = chunks.map(item => {
                    const formData = new FormData();
                    formData.append('file', item.chunk);
                    formData.append('hash', item.hash);
                    formData.append('filename', this.container.file.name);
                    formData.append('size', item.chunk.size);  // 分片文件大小
                    formData.append('total', total);  // 总分片数
                    formData.append('index', item.index);  // 当前分片索引

                    // 创建取消令牌
                    const source = axios.CancelToken.source();
                    this.cancelTokenList.push(source);

                    return axios.post('http://127.0.0.1:8000/vedios/chunk/upload', formData, {
                        cancelToken: source.token,
                        // 上传进度回调
                        onUploadProgress: progress => {
                            item.progress = Math.min(
                                Math.round((progress.loaded / progress.total) * 100),
                                100
                            );
                            const completed = this.data.filter(i => i.progress === 100).length;
                            this.percentage = Math.round((completed / total) * 100);
                        }
                    }).then(res => {
                        console.log("分片" + item.index + "已上传")
                        this.uploaded = item.index
                    });
                });
                await Promise.all(requests);
            },

            // 暂停上传
            handlePause() {
                this.cancelTokenList.forEach(source => {
                    source.cancel('用户暂停上传');
                });
                this.cancelTokenList = []
            },

            resume() {
                this.uploadChunks()
            },

            calculateHash(file) {
                return new Promise((resolve, reject) => {

                    const CHUNK_SIZE = 1024 * 1024 * 2; // 2MB 分片大小
                    let offset = 0;
                    let chunks = Math.ceil(file.size / CHUNK_SIZE);
                    let currentChunk = 0;
                    let md5State = null;

                    // 创建 Blob URL 替代外部 worker 文件
                    const script = `
let md5IntermediateState = null;
var hexcase = 0;
var b64pad = "";

function hex_md5(s) { return rstr2hex(rstr_md5(str2rstr_utf8(s))); }
function b64_md5(s) { return rstr2b64(rstr_md5(str2rstr_utf8(s))); }
function any_md5(s, e) { return rstr2any(rstr_md5(str2rstr_utf8(s)), e); }
function hex_hmac_md5(k, d) { return rstr2hex(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
function b64_hmac_md5(k, d) { return rstr2b64(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
function any_hmac_md5(k, d, e) { return rstr2any(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d)), e); }

function md5_vm_test() {
    return hex_md5("abc").toLowerCase() == "900150983cd24fb0d6963f7d28e17f72";
}

function rstr_md5(s) {
    return binl2rstr(binl_md5(rstr2binl(s), s.length * 8));
}

function rstr_hmac_md5(key, data) {
    var bkey = rstr2binl(key);
    if (bkey.length > 16) bkey = binl_md5(bkey, key.length * 8);

    var ipad = Array(16), opad = Array(16);
    for (var i = 0; i < 16; i++) {
        ipad[i] = bkey[i] ^ 0x36363636;
        opad[i] = bkey[i] ^ 0x5C5C5C5C;
    }

    var hash = binl_md5(ipad.concat(rstr2binl(data)), 512 + data.length * 8);
    return binl2rstr(binl_md5(opad.concat(hash), 512 + 128));
}

function rstr2hex(input) {
    try { hexcase } catch (e) { hexcase = 0; }
    var hex_tab = hexcase ? "0123456789ABCDEF" : "0123456789abcdef";
    var output = "";
    var x;
    for (var i = 0; i < input.length; i++) {
        x = input.charCodeAt(i);
        output += hex_tab.charAt((x >>> 4) & 0x0F)
            + hex_tab.charAt(x & 0x0F);
    }
    return output;
}

function rstr2b64(input) {
    try { b64pad } catch (e) { b64pad = ''; }
    var tab = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
    var output = "";
    var len = input.length;
    for (var i = 0; i < len; i += 3) {
        var triplet = (input.charCodeAt(i) << 16)
            | (i + 1 < len ? input.charCodeAt(i + 1) << 8 : 0)
            | (i + 2 < len ? input.charCodeAt(i + 2) : 0);
        for (var j = 0; j < 4; j++) {
            if (i * 8 + j * 6 > input.length * 8) output += b64pad;
            else output += tab.charAt((triplet >>> 6 * (3 - j)) & 0x3F);
        }
    }
    return output;
}

function rstr2any(input, encoding) {
    var divisor = encoding.length;
    var i, j, q, x, quotient;

    var dividend = Array(Math.ceil(input.length / 2));
    for (i = 0; i < dividend.length; i++) {
        dividend[i] = (input.charCodeAt(i * 2) << 8) | input.charCodeAt(i * 2 + 1);
    }

    var full_length = Math.ceil(input.length * 8 /
        (Math.log(encoding.length) / Math.log(2)));
    var remainders = Array(full_length);
    for (j = 0; j < full_length; j++) {
        quotient = Array();
        x = 0;
        for (i = 0; i < dividend.length; i++) {
            x = (x << 16) + dividend[i];
            q = Math.floor(x / divisor);
            x -= q * divisor;
            if (quotient.length > 0 || q > 0)
                quotient[quotient.length] = q;
        }
        remainders[j] = x;
        dividend = quotient;
    }

    var output = "";
    for (i = remainders.length - 1; i >= 0; i--)
        output += encoding.charAt(remainders[i]);

    return output;
}

function str2rstr_utf8(input) {
    var output = "";
    var i = -1;
    var x, y;

    while (++i < input.length) {
        x = input.charCodeAt(i);
        y = i + 1 < input.length ? input.charCodeAt(i + 1) : 0;
        if (0xD800 <= x && x <= 0xDBFF && 0xDC00 <= y && y <= 0xDFFF) {
            x = 0x10000 + ((x & 0x03FF) << 10) + (y & 0x03FF);
            i++;
        }

        if (x <= 0x7F)
            output += String.fromCharCode(x);
        else if (x <= 0x7FF)
            output += String.fromCharCode(0xC0 | ((x >>> 6) & 0x1F),
                0x80 | (x & 0x3F));
        else if (x <= 0xFFFF)
            output += String.fromCharCode(0xE0 | ((x >>> 12) & 0x0F),
                0x80 | ((x >>> 6) & 0x3F),
                0x80 | (x & 0x3F));
        else if (x <= 0x1FFFFF)
            output += String.fromCharCode(0xF0 | ((x >>> 18) & 0x07),
                0x80 | ((x >>> 12) & 0x3F),
                0x80 | ((x >>> 6) & 0x3F),
                0x80 | (x & 0x3F));
    }
    return output;
}

function str2rstr_utf16le(input) {
    var output = "";
    for (var i = 0; i < input.length; i++)
        output += String.fromCharCode(input.charCodeAt(i) & 0xFF,
            (input.charCodeAt(i) >>> 8) & 0xFF);
    return output;
}

function str2rstr_utf16be(input) {
    var output = "";
    for (var i = 0; i < input.length; i++)
        output += String.fromCharCode((input.charCodeAt(i) >>> 8) & 0xFF,
            input.charCodeAt(i) & 0xFF);
    return output;
}

function rstr2binl(input) {
    var output = Array(input.length >> 2);
    for (var i = 0; i < output.length; i++)
        output[i] = 0;
    for (var i = 0; i < input.length * 8; i += 8)
        output[i >> 5] |= (input.charCodeAt(i / 8) & 0xFF) << (i % 32);
    return output;
}

function binl2rstr(input) {
    var output = "";
    for (var i = 0; i < input.length * 32; i += 8)
        output += String.fromCharCode((input[i >> 5] >>> (i % 32)) & 0xFF);
    return output;
}

function binl_md5(x, len) {
    /* append padding */
    x[len >> 5] |= 0x80 << ((len) % 32);
    x[(((len + 64) >>> 9) << 4) + 14] = len;

    var a = 1732584193;
    var b = -271733879;
    var c = -1732584194;
    var d = 271733878;

    for (var i = 0; i < x.length; i += 16) {
        var olda = a;
        var oldb = b;
        var oldc = c;
        var oldd = d;

        a = md5_ff(a, b, c, d, x[i + 0], 7, -680876936);
        d = md5_ff(d, a, b, c, x[i + 1], 12, -389564586);
        c = md5_ff(c, d, a, b, x[i + 2], 17, 606105819);
        b = md5_ff(b, c, d, a, x[i + 3], 22, -1044525330);
        a = md5_ff(a, b, c, d, x[i + 4], 7, -176418897);
        d = md5_ff(d, a, b, c, x[i + 5], 12, 1200080426);
        c = md5_ff(c, d, a, b, x[i + 6], 17, -1473231341);
        b = md5_ff(b, c, d, a, x[i + 7], 22, -45705983);
        a = md5_ff(a, b, c, d, x[i + 8], 7, 1770035416);
        d = md5_ff(d, a, b, c, x[i + 9], 12, -1958414417);
        c = md5_ff(c, d, a, b, x[i + 10], 17, -42063);
        b = md5_ff(b, c, d, a, x[i + 11], 22, -1990404162);
        a = md5_ff(a, b, c, d, x[i + 12], 7, 1804603682);
        d = md5_ff(d, a, b, c, x[i + 13], 12, -40341101);
        c = md5_ff(c, d, a, b, x[i + 14], 17, -1502002290);
        b = md5_ff(b, c, d, a, x[i + 15], 22, 1236535329);

        a = md5_gg(a, b, c, d, x[i + 1], 5, -165796510);
        d = md5_gg(d, a, b, c, x[i + 6], 9, -1069501632);
        c = md5_gg(c, d, a, b, x[i + 11], 14, 643717713);
        b = md5_gg(b, c, d, a, x[i + 0], 20, -373897302);
        a = md5_gg(a, b, c, d, x[i + 5], 5, -701558691);
        d = md5_gg(d, a, b, c, x[i + 10], 9, 38016083);
        c = md5_gg(c, d, a, b, x[i + 15], 14, -660478335);
        b = md5_gg(b, c, d, a, x[i + 4], 20, -405537848);
        a = md5_gg(a, b, c, d, x[i + 9], 5, 568446438);
        d = md5_gg(d, a, b, c, x[i + 14], 9, -1019803690);
        c = md5_gg(c, d, a, b, x[i + 3], 14, -187363961);
        b = md5_gg(b, c, d, a, x[i + 8], 20, 1163531501);
        a = md5_gg(a, b, c, d, x[i + 13], 5, -1444681467);
        d = md5_gg(d, a, b, c, x[i + 2], 9, -51403784);
        c = md5_gg(c, d, a, b, x[i + 7], 14, 1735328473);
        b = md5_gg(b, c, d, a, x[i + 12], 20, -1926607734);

        a = md5_hh(a, b, c, d, x[i + 5], 4, -378558);
        d = md5_hh(d, a, b, c, x[i + 8], 11, -2022574463);
        c = md5_hh(c, d, a, b, x[i + 11], 16, 1839030562);
        b = md5_hh(b, c, d, a, x[i + 14], 23, -35309556);
        a = md5_hh(a, b, c, d, x[i + 1], 4, -1530992060);
        d = md5_hh(d, a, b, c, x[i + 4], 11, 1272893353);
        c = md5_hh(c, d, a, b, x[i + 7], 16, -155497632);
        b = md5_hh(b, c, d, a, x[i + 10], 23, -1094730640);
        a = md5_hh(a, b, c, d, x[i + 13], 4, 681279174);
        d = md5_hh(d, a, b, c, x[i + 0], 11, -358537222);
        c = md5_hh(c, d, a, b, x[i + 3], 16, -722521979);
        b = md5_hh(b, c, d, a, x[i + 6], 23, 76029189);
        a = md5_hh(a, b, c, d, x[i + 9], 4, -640364487);
        d = md5_hh(d, a, b, c, x[i + 12], 11, -421815835);
        c = md5_hh(c, d, a, b, x[i + 15], 16, 530742520);
        b = md5_hh(b, c, d, a, x[i + 2], 23, -995338651);

        a = md5_ii(a, b, c, d, x[i + 0], 6, -198630844);
        d = md5_ii(d, a, b, c, x[i + 7], 10, 1126891415);
        c = md5_ii(c, d, a, b, x[i + 14], 15, -1416354905);
        b = md5_ii(b, c, d, a, x[i + 5], 21, -57434055);
        a = md5_ii(a, b, c, d, x[i + 12], 6, 1700485571);
        d = md5_ii(d, a, b, c, x[i + 3], 10, -1894986606);
        c = md5_ii(c, d, a, b, x[i + 10], 15, -1051523);
        b = md5_ii(b, c, d, a, x[i + 1], 21, -2054922799);
        a = md5_ii(a, b, c, d, x[i + 8], 6, 1873313359);
        d = md5_ii(d, a, b, c, x[i + 15], 10, -30611744);
        c = md5_ii(c, d, a, b, x[i + 6], 15, -1560198380);
        b = md5_ii(b, c, d, a, x[i + 13], 21, 1309151649);
        a = md5_ii(a, b, c, d, x[i + 4], 6, -145523070);
        d = md5_ii(d, a, b, c, x[i + 11], 10, -1120210379);
        c = md5_ii(c, d, a, b, x[i + 2], 15, 718787259);
        b = md5_ii(b, c, d, a, x[i + 9], 21, -343485551);

        a = safe_add(a, olda);
        b = safe_add(b, oldb);
        c = safe_add(c, oldc);
        d = safe_add(d, oldd);
    }
    return Array(a, b, c, d);
}

function md5_cmn(q, a, b, x, s, t) {
    return safe_add(bit_rol(safe_add(safe_add(a, q), safe_add(x, t)), s), b);
}
function md5_ff(a, b, c, d, x, s, t) {
    return md5_cmn((b & c) | ((~b) & d), a, b, x, s, t);
}
function md5_gg(a, b, c, d, x, s, t) {
    return md5_cmn((b & d) | (c & (~d)), a, b, x, s, t);
}
function md5_hh(a, b, c, d, x, s, t) {
    return md5_cmn(b ^ c ^ d, a, b, x, s, t);
}
function md5_ii(a, b, c, d, x, s, t) {
    return md5_cmn(c ^ (b | (~d)), a, b, x, s, t);
}

function safe_add(x, y) {
    var lsw = (x & 0xFFFF) + (y & 0xFFFF);
    var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
    return (msw << 16) | (lsw & 0xFFFF);
}

function bit_rol(num, cnt) {
    return (num << cnt) | (num >>> (32 - cnt));
}

function buffer2Binary(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return binary;
}

self.onmessage = function (e) {
    const { type, chunk, isFinal } = e.data;

    switch (type) {

        case 'init':
            md5IntermediateState = null;
            self.postMessage({ type: 'ready' });
            break;


        case 'update':
            if (!(chunk instanceof ArrayBuffer)) {
                self.postMessage({ type: 'error', msg: '分片必须是 ArrayBuffer 类型' });
                return;
            }

            const binaryChunk = buffer2Binary(chunk);

            const chunkBinl = rstr2binl(binaryChunk);
            const chunkLen = binaryChunk.length * 8; // 数据长度（比特）


            if (!md5IntermediateState)
                md5IntermediateState = binl_md5(chunkBinl, chunkLen);
            else {
                md5IntermediateState = binl_md5(
                    md5IntermediateState.concat(chunkBinl), // 前状态 + 当前分片
                    md5IntermediateState.length * 32 + chunkLen // 总长度（前状态比特数 + 当前分片比特数）
                );
            }

            if (isFinal) {
                const finalRstr = binl2rstr(md5IntermediateState);
                const finalHash = hex_md5(finalRstr); // 转成 32 位小写 MD5
                self.postMessage({ type: 'hash', hash: finalHash });
            }
            break;

        // 处理错误场景
        default:
            self.postMessage({ type: 'error' });
    }
};
                    `;

                    const blob = new Blob([script], { type: 'application/javascript' });
                    const workerUrl = URL.createObjectURL(blob);
                    const worker = new Worker(workerUrl);

                    const read = (file) => {
                        if (currentChunk >= chunks) return;
                        const reader = new FileReader();
                        // 用单个文件的 slice 方法截取分片（正确）
                        const slice = file.slice(offset, offset + CHUNK_SIZE);
                        reader.readAsArrayBuffer(slice);

                        reader.onload = (event) => {
                            const chunkBuffer = event.target.result;
                            worker.postMessage(
                                {
                                    type: 'update',
                                    chunk: chunkBuffer,
                                    isFinal: currentChunk === chunks - 1
                                },
                                [chunkBuffer]
                            );
                            offset += CHUNK_SIZE;
                            currentChunk++;
                            read(file); // 递归传递单个文件
                        };

                        reader.onerror = (error) => {
                            reject(new Error(`分片读取失败：${error.message}`));
                            URL.revokeObjectURL(workerUrl);
                            worker.terminate();
                        };
                    };

                    worker.onmessage = (e) => {
                        const { type, hash, error, msg } = e.data;
                        if (error) {
                            reject(new Error(msg));
                            URL.revokeObjectURL(workerUrl);
                            worker.terminate();
                            return;
                        }
                        switch (type) {
                            case 'ready':
                                // 5. 修复：调用 read 时传递单个文件 file，而非 files[0]
                                read(file);
                                break;
                            case 'hash':
                                URL.revokeObjectURL(workerUrl);
                                worker.terminate();
                                resolve(hash);
                                break;
                            default:
                                reject(new Error(`不支持的 Worker 消息类型：${type}`));
                        }
                    };
                    worker.postMessage({ type: 'init' });
                });
            },
        }
    })
</script>
<html>